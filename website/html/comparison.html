<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Exoplanet — Actual vs Model (Blues Gradient & Red Rings)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root { --gap: 12px; --border: #222; --muted: #a3a3a3; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: #0b0b0f; color: #e5e7eb;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    header {
      position: sticky; top: 0; z-index: 10; background: #0b0b0f; border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 12px; display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;
    }
    header h1 { margin: 0 0 4px; font-size: 18px; font-weight: 700; color: #fff; }
    header .hint { margin: 0; color: var(--muted); font-size: 13px; }
    .controls { display: grid; grid-auto-flow: column; gap: 8px; align-items: center; }
    .controls input[type="file"], .controls select {
      padding: 6px 8px; border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; background: #111319; color: #e5e7eb;
    }
    .controls button {
      padding: 8px 12px; background: #2563eb; color: #fff; border: 1px solid rgba(255,255,255,0.12); border-radius: 8px;
      cursor: pointer; font-weight: 600;
    }
    main { padding: var(--gap); display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); min-height: calc(100vh - 88px); }
    .panel { display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.08); border-radius: 14px;
      background: linear-gradient(180deg, rgba(18,20,28,0.9), rgba(10,10,14,0.9)); overflow: hidden; min-height: 0; position: relative; }
    .panel .title { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.08); font-weight: 700; color: #fff;
      display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .title .actions { display: inline-flex; gap: 8px; }
    .title .actions button { background: #374151; color: #e5e7eb; border: 1px solid rgba(255,255,255,0.1); padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .plot { width: 100%; height: 62vh; min-height: 360px; }
    .legend-box { padding: 10px 12px; border-top: 1px solid rgba(255,255,255,0.08); display: grid; gap: 6px; }
    .legend-title { font-size: 12px; color: #d1d5db; }
    .legend-bar { height: 14px; border-radius: 6px; background: linear-gradient(90deg, #dbeafe 0%, #60a5fa 60%, #1e3a8a 100%);
      border: 1px solid rgba(255,255,255,0.15); }
    .legend-ticks { display: flex; justify-content: space-between; font-size: 11px; color: var(--muted); }
    @media (max-width: 980px) { main { grid-template-columns: 1fr; } .plot { height: 48vh; } }

    /* Fullscreen toggle */
    .fs { position: fixed !important; inset: 0 !important; z-index: 9999 !important; border-radius: 0 !important; }
    .fs .plot { height: 100% !important; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Actual vs Model</h1>
      <p class="hint">Left: actual (categorical). Right: model with three bands — <strong>white</strong> (&lt;0.25), <strong>Blues gradient</strong> (0.25–0.75), <strong>dark blue</strong> (≥0.75). Confirmed → <strong>red ring</strong>. Click “Fullscreen” to go deep.</p>
    </div>
    <div class="controls">
      <input id="fileInput" type="file" accept=".csv" />
      <select id="xSelect"></select>
      <select id="ySelect"></select>
      <button id="plotBtn" type="button">Plot</button>
    </div>
  </header>

  <main>
    <section class="panel" id="panelLeft">
      <div class="title">
        <span>Actual Distribution</span>
        <span class="actions">
          <button type="button" onclick="toggleFS('panelLeft')">Fullscreen</button>
        </span>
      </div>
      <div id="leftPlot" class="plot"></div>
      <div class="legend-box">
        <div class="legend-title">Legend</div>
        <div class="hint">Colored by <code>actual_label</code> (categorical).</div>
        <span class="hint" id="leftInfo"></span>
      </div>
    </section>

    <section class="panel" id="panelRight">
      <div class="title">
        <span>Model Prediction</span>
        <span class="actions">
          <button type="button" onclick="toggleFS('panelRight')">Fullscreen</button>
        </span>
      </div>
      <div id="rightPlot" class="plot"></div>
      <div class="legend-box">
        <div class="legend-title">Candidates — Confidence(+)</div>
        <div class="legend-bar" aria-label="Confidence gradient (light→dark blue)"></div>
        <div class="legend-ticks"><span>0.25</span><span>0.50</span><span>0.75</span></div>
        <span class="hint" id="rightInfo"></span>
      </div>
    </section>
  </main>

  <script>
    const isNum = v => typeof v === 'number' && !Number.isNaN(v) && Number.isFinite(v);
    let rows = [], allCols = [], numCols = [];

    const fileInput = document.getElementById('fileInput');
    const xSelect = document.getElementById('xSelect');
    const ySelect = document.getElementById('ySelect');
    const btnPlot = document.getElementById('plotBtn');
    const leftInfo = document.getElementById('leftInfo');
    const rightInfo = document.getElementById('rightInfo');

    fileInput.addEventListener('change', onFile);
    btnPlot.addEventListener('click', render);

    function toggleFS(id){
      const el = document.getElementById(id);
      el.classList.toggle('fs');
      // Force Plotly to relayout for new size
      const plotId = (id === 'panelLeft') ? 'leftPlot' : 'rightPlot';
      setTimeout(()=>{ Plotly.Plots.resize(document.getElementById(plotId)); }, 150);
    }

    function onFile(e) {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      Papa.parse(f, {
        header: true, dynamicTyping: true, skipEmptyLines: true,
        complete: res => {
          rows = res.data || [];
          allCols = res.meta?.fields || Object.keys(rows[0] || {});
          numCols = inferNumericColumns(rows, allCols);
          fillSelect(xSelect, numCols, guess(numCols, 'period'));
          fillSelect(ySelect, numCols, Math.min(1, numCols.length - 1));
          leftInfo.textContent = `${rows.length} rows · ${allCols.length} cols`;
          rightInfo.textContent = `bands: <0.25 / 0.25–0.75 / ≥0.75 · color=confidence_positive`;
        }
      });
    }

    function inferNumericColumns(r, cols) {
      return cols.filter(c => {
        let n = 0, ok = 0;
        for (const x of r) {
          if (x[c] !== undefined && x[c] !== null && x[c] !== '') {
            n++; if (isNum(x[c])) ok++;
          }
        }
        return n >= 5 && ok / Math.max(1, n) >= 0.9;
      });
    }
    function fillSelect(sel, opts, idx=0){ sel.innerHTML=''; opts.forEach((o,i)=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; if(i===idx) op.selected=true; sel.appendChild(op); }); }
    function guess(list, key){ const i=list.findIndex(c=>c.toLowerCase()===String(key).toLowerCase()); return i>=0?i:0; }

    function render(){
      if(!rows.length){ alert('Upload a CSV first.'); return; }
      const x = xSelect.value, y = ySelect.value;

      const X=[], Y=[], actual=[], conf=[];
      for(const r of rows){
        const xv=r[x], yv=r[y];
        if(isNum(xv) && isNum(yv)){
          X.push(xv); Y.push(yv);
          actual.push(r.actual_label ?? null);
          conf.push(isNum(r.confidence_positive) ? r.confidence_positive : null);
        }
      }

      // LEFT: actual (categorical colors) — smaller dots
      const palette = ['#60a5fa','#f59e0b','#10b981','#f472b6','#a78bfa','#ef4444','#22d3ee','#eab308','#84cc16','#fb7185'];
      const leftColors = actual.map(v=>{
        if(v===null) return 'rgba(180,180,190,0.35)';
        const key = String(v);
        let h = 0; for(let i=0;i<key.length;i++) h = (h*31 + key.charCodeAt(i))>>>0;
        return palette[h % palette.length];
      });
      const leftTrace = {
        type:'scattergl', mode:'markers', x:X, y:Y,
        marker:{ size:3.5, color:leftColors, line:{width:0.3, color:'rgba(255,255,255,0.6)'} },
        hovertemplate:`${x}=%{x}<br>${y}=%{y}<extra></extra>`, name:'Actual'
      };
      const cfg = { displaylogo:false, scrollZoom:true, doubleClick:"reset", modeBarButtonsToAdd:["toggleSpikelines","hovercompare","v1hovermode"] };
      Plotly.newPlot('leftPlot', [leftTrace], {template:'plotly_dark', margin:{l:50,r:20,t:20,b:50}, xaxis:{title:x}, yaxis:{title:y}, uirevision:"keep"}, cfg);

      // RIGHT: three bands + red rings for confirmed — smaller dots
      const thrLow  = 0.25;
      const thrHigh = 0.75;

      const maskCandidate = conf.map(v => (v !== null && v >= thrLow && v < thrHigh));
      const maskPlanet    = conf.map(v => (v !== null && v >= thrHigh));
      const maskNot       = conf.map((v,i) => !(maskCandidate[i] || maskPlanet[i]));

      const Xnot=[], Ynot=[], Xcand=[], Ycand=[], Ccand=[], Xplan=[], Yplan=[];
      for (let i=0;i<X.length;i++){
        if (maskNot[i])         { Xnot.push(X[i]);  Ynot.push(Y[i]); }
        else if (maskCandidate[i]) { Xcand.push(X[i]); Ycand.push(Y[i]); Ccand.push(conf[i]); }
        else if (maskPlanet[i])    { Xplan.push(X[i]); Yplan.push(Y[i]); }
      }

      const whiteTrace = {
        type:'scattergl', mode:'markers', x:Xnot, y:Ynot,
        name:`Not exoplanet (< ${thrLow.toFixed(2)})`,
        marker:{ color:'white', size:3.5, line:{width:0.3, color:'rgba(0,0,0,0.3)'} },
        hovertemplate:`${x}=%{x}<br>${y}=%{y}<extra></extra>`
      };

      const candTrace = {
        type:'scattergl', mode:'markers', x:Xcand, y:Ycand,
        name:`Candidate [${thrLow.toFixed(2)}, ${thrHigh.toFixed(2)})`,
        marker:{
          size:3.5, color:Ccand, colorscale:'Blues', cmin:thrLow, cmax:thrHigh, showscale:true,
          colorbar:{ title:'Confidence+' }, line:{width:0.3, color:'rgba(255,255,255,0.6)'}
        },
        hovertemplate:`${x}=%{x}<br>${y}=%{y}<br>conf+=%{marker.color:.2f}<extra></extra>`
      };

      const planTrace = {
        type:'scattergl', mode:'markers', x:Xplan, y:Yplan,
        name:`Exoplanet (≥ ${thrHigh.toFixed(2)})`,
        marker:{ size:3.5, color:'#1e3a8a', line:{width:0.3, color:'rgba(255,255,255,0.6)'} },
        hovertemplate:`${x}=%{x}<br>${y}=%{y}<extra>exoplanet</extra>`
      };

      // Confirmed ring overlay — red ring
      const ringX=[], ringY=[];
      for(let i=0;i<actual.length;i++){
        const v = actual[i];
        const isConf = (typeof v==='number') ? (v===1) : (v!==null && String(v).toLowerCase().includes('confirm'));
        if(isConf){ ringX.push(X[i]); ringY.push(Y[i]); }
      }
      const ringTrace = {
        type:'scattergl', mode:'markers', x:ringX, y:ringY, name:'Confirmed (ring)',
        marker:{ size:6, color:'rgba(0,0,0,0)', line:{width:1.5, color:'red'} },
        hovertemplate:`${x}=%{x}<br>${y}=%{y}<extra>confirmed</extra>`
      };

      Plotly.newPlot('rightPlot', [whiteTrace, candTrace, planTrace, ringTrace],
        {template:'plotly_dark', margin:{l:50,r:20,t:20,b:50}, xaxis:{title:x}, yaxis:{title:y}, uirevision:"keep"},
        cfg
      );

      leftInfo.textContent  = `x=${x}, y=${y} · color=actual_label`;
      rightInfo.textContent = `x=${x}, y=${y} · bands: <${thrLow} / ${thrLow}-${thrHigh} / ≥${thrHigh}`;
    }

    // Optional autoload via URL (?csv=data/predicted.csv)
    (function autoload(){
      const p=new URLSearchParams(location.search); const url=p.get('csv');
      if(!url) return;
      fetch(url).then(r=>r.text()).then(text=>{
        const res=Papa.parse(text,{header:true,dynamicTyping:true,skipEmptyLines:true});
        rows=res.data||[]; allCols=res.meta?.fields||Object.keys(rows[0]||{}); 
        numCols = (function(r, cols){ return cols.filter(c=>{let n=0,ok=0;for(const x of r){if(x[c]!==undefined&&x[c]!==null&&x[c]!==''){n++; if(typeof x[c]==='number'&&isFinite(x[c])) ok++;}} return n>=5&&ok/Math.max(1,n)>=0.9;});})(rows, allCols);
        fillSelect(xSelect, numCols, numCols.findIndex(c=>c.toLowerCase()==='period')>=0?numCols.findIndex(c=>c.toLowerCase()==='period'):0);
        fillSelect(ySelect, numCols, Math.min(1, numCols.length-1));
        leftInfo.textContent = `${rows.length} rows · ${allCols.length} cols`;
        rightInfo.textContent = `bands: <0.25 / 0.25–0.75 / ≥0.75 · color=confidence_positive`;
      }).catch(()=>{});
    })();
  </script>
</body>
</html>